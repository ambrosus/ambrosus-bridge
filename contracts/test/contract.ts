import {deployments, ethers, getNamedAccounts, network} from "hardhat";
import type {Contract, Signer, ContractTransaction, ContractReceipt} from "ethers";

import chai from "chai";


chai.should();
export const expect = chai.expect;


describe("Contract", () => {
  let ownerS: Signer;
  let owner: string;

  let ethBridge: Contract;
  let ambBridge: Contract;

  before(async () => {
    await deployments.fixture(["ethbridge", "ambbridge"]);
    ({owner} = await getNamedAccounts());
    ownerS = await ethers.getSigner(owner);
    ethBridge = await ethers.getContract("EthBridge", ownerS);
    ambBridge = await ethers.getContract("AmbBridge", ownerS);
  });

  beforeEach(async () => {
    await deployments.fixture(["ethbridge", "ambbridge"]); // reset contracts state
  });




  it('TestSign', async () => {
    // amb main net block 16021709

    const hash = "0x6a6249e2d7c2aca375164f7eb233dfa23a8c0ff7046520849894ee23dd026eaf"
    const msg = ethers.utils.arrayify(hash);
    const signature = "0xe437f2d7a70044b9b7c1d98cde917b28e7e0298ab26abdbeacd3fd81de6100af5a61014a397218b4fb36230867634db0e5e40d4c17dd8b69979e52eb2fb9217e1b";

    const address = ethers.utils.recoverAddress(msg, signature);
    expect(address).eq("0x7a3599b88EA2068268B763deE8B8703d21700DF3");
  });



  it('TestAll', async () => {


    // all data from go relay, https://rinkeby.etherscan.io/address/0x295C2707319ad4BecA6b5bb4086617fD6F240CfE

    const rlpBlocks = [
      ["0xf9025ea0bbc7f0e38929ec0a39456a5bae6cb5a6b78f8221d3847c1f769870538e45b8bda01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347940000000000000000000000000000000000000000a03a1574ced84331e0c923ee8b59e3157c9e6c31b0bbb7229e075d344f77c294a4a086528e2027ea96e35f4f0d8b6f267142c3a08514e70e64b810ee7851c30e7d2aa0", "0x0e19377a0bfb933115babbc12b4c8dbdac491e6b59346d1d311204af82c4dd08", "0xb9010000000001020010340000000080000000000000004005402000402010008008420150000000000000000000000808000000000020082260800810004000240001100000000090000000000028002000000004010001040000000800808002080802800000060040001080000400000800420000100400000104040010100000080802100002440000400100000000000000000480000000000402800008004000020000001040000c000001080000000004000080040100040000182200080100000404020000000000010010003000080250000000810000000000200800e00100100c00000000000001000100000000a0010000100000004000520000000081018395405e8401c9c3808325a6c784", "0x61b137ee", "0xb861696e667572612e696f000000000000000000000000000000000000000000000010541caf38c3485e0d9459ccd31e6031b32bda1465b75f534ffa4209242818490faa202b60842f53150f7f76d447f968421d181a03f4bdc2d7e58f0be5643e6e01a0000000000000000000000000000000000000000000000000000000000000000088000000000000000009", ],
      ["0xf9025ea0", "0x1cd7bc73b74bd8ab52f9acc422de0a29be3e263a74f9cffe3bc00a61d25870fc", "0xa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347940000000000000000000000000000000000000000a0dde85e2b8d314f59e054fac21ddcd03df33e50c5efe151c6be1a66d582e5c0b7a0dd9284831cb8028a6270caec4aac6e1f79a29162933bbfed953b676ce9085d72a0fb9a806f63a0e01440fad77be564089d59e73970e803656d66b91f74689bd25cb901000a800002024800221080418020004014000000800000000000100402008102024020800000001020010000000000000000000000022a90200000008000040a89100088504000000010080028010040022414030c20450000002800a4000000012980808002000018000a000000240800400000002400004100101030900000000000104080442421000100420600601400008680000210814006040060402010000400000000001408240808000400002000a004808050044424040004004a0000000802000000060000049080400008804a000080a0004202009201004060000200001081108000000600010000000101020000149022020000200000044003028395405f8401c951118329a25584", "0x61b137fd", "0xb861d883010a09846765746888676f312e31362e36856c696e757800000000000000bb92c3d7e9e0eac3ecd1b82d27f23bf8b5247784aa86afff820d4ec2f1a7d25b16144979532612c3d5fe7d1fcea3d8d65a41e1c698061f816c1ba19981ae6f8200a0000000000000000000000000000000000000000000000000000000000000000088000000000000000009", ],
      ["0xf9025ea0", "0xc4916710fcfc26b178b87cbb6a1bfbcc0bae38531151d0557ecf0494c24f3e6b", "0xa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347940000000000000000000000000000000000000000a0b24e3b2a7d87b206364b3c20a8266963be938a8c4b86f5176165e60b01aa80f6a05a367d9b321c07624bf6958d7b4105d7fab106918795aa65447877f90b9f41eea0b05b0b1cc7a07a01cc1e6abb1fa5253f9a048e4a3b62c837a6987ea166471d01b9010020202440121002220000100020040a12828208600010440040c2002818e000158010004000004080002300084000c000100002000a0220804000000a10a52240100054048050000023020228020041130001200b020410400000008000004b004900801006a088000082d890c0000802c002004214100021348004581020004000000800b640200060604800008400040020078200540016a4109004040020000a0080804000005e0180011a40000080460160800089040480a608000800510520411c420404010800004a000282810c4240810080801020112000b00800e404001804040058840304d100d68000400084000000010200001c6003054080010a02839540608401c8debe834b666d84", "0x61b1380c", "0xb861d883010a0d846765746888676f312e31372e33856c696e757800000000000000047ccb4f34aa2b78b872138f6580cb20327d253e2f983737dd94cbb05de31e0b7e20c58ac52963b70890e30eb9a09cff194308581a0d950557f3e9238193906500a0000000000000000000000000000000000000000000000000000000000000000088000000000000000009", ],
      ["0xf9025ea0", "0x132f70a905706cb3c776cc6d1800920197d13aed1d6ed34664da188ab7fe3de5", "0xa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347940000000000000000000000000000000000000000a08f5e649e54070bf57cf83c1c791b6123e3b1ae8b8d7b6bd8a4cd15e3ef13bc59a07101b6bda610985c431ddfcde457747254af1d3aa29aa1ec0359e21e1000c694a08514066a700cbc5541508c193429b8df0e863ae50fb24465e02281284a166206b9010009200000020020000090120080340090108a08a040100400408508880020021180500000a2c00008082000000580800000000602020800000004000010a5000004000c04c4000040010021080200013300012000040050020000004180504820418084000220000020005090c000180080000444104000002020101810000040040020003322140000400802060600142024010300440008a10010404600000003040000002200040000004c000000804000a00000010402802604000c003004200904020100002810101a2001c20040c00041000880101010000000080020000810401001000022040000848000000000202000002020400d4041000824000802839540618401c950f4834c87dc84", "0x61b1381b", "0xb861d883010a0e846765746888676f312e31372e33856c696e757800000000000000233a6b58a5a4806c94923f2e86600ccdb9eef706f7825549401589b87c544ff039c0132cd9dc5ab26149e5ea1c6ac69801444877f59763dc43d47162224117b501a0000000000000000000000000000000000000000000000000000000000000000088000000000000000009", ],
      ["0xf9025ea0", "0x6c3837fa6d6ae6b3295d2fe48f1959da61969670f0834ca2ebfd7cab66db3512", "0xa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347940000000000000000000000000000000000000000a076b7253ed27205c6d38e86720939720583682df92f3842009146b970efe81651a09ba721951a8ce1ceb4785bb0a40d8e309f3794befd4e7f3301fe5e98daebaaaca07c18d966d4ce9c53cda290a9cf1856b0ec6e65b626437843da3ba98cff82efe3b9010014a0000412c020090020001080444400002000020001003040810000128002200000100080018004000800c0100000400100040002226000000008000020000514002004000080000300200902280022000921000504020200000040000000004010000202800000400011244004480240000028040000082001201014000348900020200a44000040410025004400002080058020602008a800a04010000800020820001800800c010000080000001000002014008000040522082004044500c80c04c24000002040000000008001080260010400a810100404002460002000141000000000000000000880800020000000000100800000820400004020010102839540628401c9c347836890ce84", "0x61b1382a", "0xb861696e667572612e696f0000000000000000000000000000000000000000000000652a74ef555c0d07e00b93a11f6716dcf0c6011b0fe8132d6aacd77daae56a3417dd91faef283aed534e54f3b3bdfa70fb99eaa49b71dba09fbd1324a4b9e90301a0000000000000000000000000000000000000000000000000000000000000000088000000000000000009", ],
      ["0xf9025ea0", "0x34f11e74a6d24f6bfcf9f8018edf22257761e12807545f4d2e164f2523a5ed2a", "0xa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347940000000000000000000000000000000000000000a0aaa776e5a2245002e083ff56b34a1f87834bf5a3eb5d4a14320dcb2d306d4e5ca07c3b3f35cf90888ba094ce1ba8a8b3f68cf9e62f2c8be5650d09c0ac8b112d64a0e998090fe5bb46cc533f14de598a8afbb2a2819b233a4294afdb0765586ea48bb901000000000222401000008040022004881060002002040182a040108000000002025000000040010801500802000000000001008000040c00941200001000a620020010189048008020010a110842000b120000220d0004081004200c0680420081408080040200000000001000c0002800100000010000000060001250040006405210b00600040c240004c00268426014009008000044c881a800010050400009260c00a00008800400100008200400000000600a0000000405124c0800001000840204028000000820084480c080000082204104002a000002901290d000680414104412c55082c400860000884500051080010101a03204008001400804000001839540638401c950d88347be0a84", "0x61b13839", "0xb861d883010a09846765746888676f312e31362e36856c696e757800000000000000c83f21b2d32f3958d7722a366ddf19109ad59513427f127214e946ebd75f12485747ea44ae9641ccc81b40d437fb1d42906c5b5f6058a54d6fac183cc579598f00a0000000000000000000000000000000000000000000000000000000000000000088000000000000000009", ],
      ["0xf9025ea0", "0x9dee23d06bba6f0f113d2d47bb39c6716821ab053a13ea76ec3de9a5cc569690", "0xa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347940000000000000000000000000000000000000000a036a6257a9d1bc2c3abe385cb27f3c78441ed8cf86205ecfe796471c1e3b15d6fa00eeadee9c7ede48dfa501ec3262d8f2ddda95731d5fa80fd5f5c5d2012bdc80da0bab3198a8c8880d108ff398f9f410b53b9ef2fba7d0705a02a4da9fdcaa6f7cfb9010000000000000440002008500000140000000000400080200040c408800002001a00000000000000682100000000080210204000010000000800080002002440000002200440100020110000080a40000000012224040410014000000300000c80d000000002000000000010044010482002030000004001002820081080408040000000000000800000800000050440000000000000400021a000000400400004020000000800001800020800100000002002a00000200010000200040040000080000402000000020000048080d0000400000100008010000b10160000016200001200008110000000000040800000000020400010000200008009800400000602839540648401c9c32b833ed9a684", "0x61b13848", "0xb861d883010a0e846765746888676f312e31372e33856c696e7578000000000000003b7cda9261f8d0bf629484a32b82954c6ff209ac8b19c3216f0aa1559a42cfee50c228b12c0fe48ae7079cafca457739f38d6d0bf0290f46c9f6c7bc1d33d8ac01a0000000000000000000000000000000000000000000000000000000000000000088000000000000000009", ],
      ["0xf9025ea0", "0xd40de2128eac41cbffd9e39eaef2f17c708dcc9ad8af153f1aed668ac2530ea0", "0xa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347940000000000000000000000000000000000000000a046c2f0b4e0329748e2bbb5c8ec34ccafa61f6713bb638489cabd18f7d160bc23a093264a69a53572ae41c9bb13bd419a8e739a0eba230cad029931df65bf1b7d8fa05d2566e0a30150d0e90b99b1b7975851290e35748f4b1c3611721d9b3094ca0db901002c8080001800336000c45850009402005801230042000420409248a000000000918008004008020e8100005211000840410134000e4480800420200c20244004040034154212800809020109420a00420123e20c0404014c80041c51a00603804a44022033a008004480188044204800040000404802020020001010060000484080800c88080800490088010615465008001b0120540000a100020400400a00021040004000011021080180000018202200b00860b0c06220b2840814004802480194420800000804000cd000e001642061810080880000061011820010e0220210180280480004041100808000000080002100018086440800010558a00d0001839540658401c950bc83e9e91d84", "0x61b13857", "0xb861d883010a0d846765746888676f312e31372e33856c696e757800000000000000e0098c9604f9f3e6e0734902399815de71cb5e4b71243e4538faf4ff635f0ea92543868d8ffdf9b55134fc241b93e71a2d004c0d8d8906193f150490aea6926600a0000000000000000000000000000000000000000000000000000000000000000088000000000000000009", ],
      ["0xf9025ea0", "0xfb404f37f067b82ff404a0b38f8c30d5dba827c599754126066850f9bb70bb5e", "0xa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347940000000000000000000000000000000000000000a02971da0af3a5d75051ef33a6f4720d853c98958be8e806222359aa2e9a694116a09bc02ce9cbb375555c8dc375eb224a2646a6ad2df0a69805f1b924d08bcccb0ba01d0be5bdbc325348938bb4ea128ce060ca3d1d4519cc2ed7adf2e01065df716fb90100000000004200000000080000000000004000000000000000008000000204000041011000000000000000000800080000000000100022000000000000008002810000000000004000004000090120420000010101010000000000000006000000010000400200040000000000000008000000000000000001042000122020004400000000000420000001080000000000400004800000000200044001000020000000000010000000000000000000000000200000000000000000010000008000000005220000004000000000000000000244000400020000000000000000a00000008000005080000040000400000000000000000d000000010000000004000101839540668401c9c30f832f081084", "0x61b13866", "0xb861d883010a0e846765746888676f312e31372e33856c696e75780000000000000002d793f5654b13ddca9661e4f91f3a9cc9a075950530e835bcb6643026baa34221bba8eecda88ec0813b764cc778986089e0416d039748c2ba55a8acfe52c2da01a000000000000000000000000000000000000000000000000000000000000000008800000000000000000a", ],
      ["0xf9025ea0", "0xa7f4be764535e550f8fbedb0cc7bb9f777f5863bc2b72cff1527e1b207fac4e1", "0xa01dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347940000000000000000000000000000000000000000a09716ac999ae631f422eea2274d032f3589c3694314207cade5263b08d6ac736ba06ea506753a8360ed84d688cb599660ff3d2ea1110f18852b476452a4de4254e6a05a938502b91dad69c6a57b72a554ce720de45fee01b7ae2014125aec0252bc58b901000000000000000000000000000000080000002000000400000080000000000000000010040000c00000000000000000000000000000200000000010000004220100104200000000080000000801004000000901010004000000000000100001010010040002004000040008000000080024000002000000010800001000200040040000000004200000010000000000000000000000000000001000000000000000040000000000000000000001000800000000002000000000000100000000000000000204008000000000000000000400000000000000000000000000006000200084000010800000000000000000000000000000000000110806000100000101839540678401c9c380831fb59b84", "0x61b13875", "0xb861696e667572612e696f00000000000000000000000000000000000000000000008f1d15be2af5ea151f3214ed4908a41246f3cc006a3cce4ceec626c55e0a5afd14f80788fbe6a4b966762f26a0dccf0982306e3aabd9d0ae70cc14cc3a1c567600a000000000000000000000000000000000000000000000000000000000000000008800000000000000000a", ],
    ];
    const proof = ["0xf9027220b9026e02f9026a0183236fc6b9010000000000000000000000000000000000000000000004002000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000002000000004000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000008000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f9015ff9015c9467374e81da10af874664fec38bacd9137774f58ef842a088d88376da47bd16f6e8e45064996475d1536ab348a4f812de2f22518e06ee2da034b75fc0c8cd8e0b812bc8a3e1250f2287c67acee53b934091d34f4e81a20733b90100", "0x", "0xf891a049f601f6a3f228fc1bb8b67d859421ca82a03760a7ea61dd48557b7e016a6a25a0", "0xa0dd79151e8e1cfaa71c6afa47276326e1b7712a072c8ed37b3c6410389a112360a095aa56b747376fc8f3966bab353cc1f021280c793c8465285d4a17d8867044c880808080808080808080808080", "0xf871a0543013b82f229db241cc109973d1c570b96a15014367f79d434a0a3ab88732cca0", "0x808080808080a0449d4b558ab1dd1bc88d1e456bf9c7cff9e09370c045086eb062515407e1fa3e8080808080808080", ];

    const events = [
      ["0x295c2707319ad4beca6b5bb4086617fd6f240cfe", "0x295c2707319ad4beca6b5bb4086617fd6f240cfe", 123],
      ["0x295c2707319ad4beca6b5bb4086617fd6f240cfe", "0x295c2707319ad4beca6b5bb4086617fd6f240cfe", 456],

    ];


    for (let block of rlpBlocks) {
      const hash = ethers.utils.arrayify(ethers.utils.keccak256(ethers.utils.concat(block)));
      const signature = await ownerS.signMessage(hash);
      block.push(signature);
    }


    await ethBridge.CheckPoA_(rlpBlocks, events, proof);
    await ambBridge.CheckPoW_(rlpBlocks, events, proof);

  });

  it('CheckReceiptsProof', async () => {

    const receiptsRoot = "0x0e19377a0bfb933115babbc12b4c8dbdac491e6b59346d1d311204af82c4dd08"
    const eventToCheck = "0x000000000000000000000000a17d0240c839e5461fd897a943080e3420156d40"
    const proof = [
      "0xf9024f20b9024b02f902470183044f90b9010000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000008000000000000000000000000000000200000000000000010000000000008000000000000000000000000000000000000080000000000020000000000000400000800020000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000020000000000000800000000000000000000000004000000000000000000000000000002000000000000000000000000000000000000000000000000000020000010000000000000000000000000000000000000000000000000000000000000f9013cf89c94564c7dacc723f92f9287ade47f1fb553dc8986eaf884a08c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b925a0",
      "0xa00000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000000080f89c94564c7dacc723f92f9287ade47f1fb553dc8986eaf884a0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3efa0000000000000000000000000a17d0240c839e5461fd897a943080e3420156d40a00000000000000000000000005dc90c1582ba6b2af0d539fc076c94c584653faca0000000000000000000000000000000000000000000000000000000000000000080",
      "0xf901f180a0712a86434306bd9a49808ad6b19fed18016356a6b3718db019017a29b4ddd690a0",
      "0xa0ffcd39ae80db397d871917099f4d16c1d964b5968f622953519798c04c1fb6c4a0477a3b710fb3df4c8be2e03b80a999fe369b3ac955cafbe56a74b1518e73b325a04381d92bff3bc6b706f88f6c9020c3fe02929156e6d5e4a704d826cf11158b21a04cb1b1f4e5e34957430326ae5f082014e7c8258adcc9342f2c711fedb2160e89a00d427a16885eb1878991c4283d0804f56faaf392795566505001d88c3ca865eda03d5c0206dd0d877bf10ec8bee3177c6dfa88caf923408962e8783c39b4084607a078ce17ac5542c38c0975dd6dbb73040758fe160e8c8889bd7a98a131cfee92d5a0bac40bf499bace323f8714e8bccb68ed46776307371ab18907f81b1ca496c0c7a00880578c4c5e2a5228cb589249762bb8fe69fdcbef276a6d67b00871abb4be94a0f1db54679b31c6c2197ef4ce99a043f810a85c1ee8d16ad09794073f8559d935a0c2d20c5ffebf3b01ad547d443449258a4405d681e8f6cbf7ae3edd94651a27c4a01eb60f9187783bf53e7900ddf527567ca2ea4291494a2fa442b482b72f5d842aa088ede6d13f18c64710d981a882f88d1bdb0bb94559aef758016a9c5ad4baa48e80",
      "0xf871a0",
      "0xa05621bdcbf22658e545e8288486f0a32cbfd514319b4721fd629b28f30eb1f4f4808080808080a0449d4b558ab1dd1bc88d1e456bf9c7cff9e09370c045086eb062515407e1fa3e8080808080808080"]


    await ethBridge.CheckReceiptsProof(proof, eventToCheck, receiptsRoot);
    await ambBridge.CheckReceiptsProof(proof, eventToCheck, receiptsRoot);
  });


  it("TestWithdraw timeframe", async ()=> {
    let [addr1, addr2, _] = await ethers.getSigners();
    await ambBridge.withdraw(addr1.address, addr2.address, 1, {value: 1000});
    await ambBridge.withdraw(addr1.address, addr2.address, 2, {value: 1000});
    await nextTimeframe();
    let tx1: ContractTransaction = await ambBridge.withdraw(addr1.address, addr2.address, 1337, {value: 1000});
    await ambBridge.withdraw(addr1.address, addr2.address, 3, {value: 1000});
    await ambBridge.withdraw(addr1.address, addr2.address, 4, {value: 1000});
    await nextTimeframe();
    let tx2: ContractTransaction = await ambBridge.withdraw(addr1.address, addr2.address, 1337, {value: 1000});
    await ambBridge.withdraw(addr1.address, addr2.address, 5, {value: 1000});

    let receipt1: ContractReceipt = await tx1.wait();
    let receipt2: ContractReceipt = await tx2.wait();

    let events1: any = await receipt1.events?.filter((x: any) => {return x.event == "TransferEvent"});
    let events2: any = await receipt2.events?.filter((x: any) => {return x.event == "TransferEvent"});
    expect(events2[0].args.event_id).eq(events1[0].args.event_id.add("1"));
  });

  let currentTimeframe = Math.floor(Date.now() / 14400);
  const nextTimeframe = async (amount = 1) => {
    currentTimeframe += amount;
    const timestamp = currentTimeframe * 14400 + amount * 14400;
    await network.provider.send("evm_setNextBlockTimestamp", [timestamp]);
  }
});
